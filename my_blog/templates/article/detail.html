<!-- extends表明此页面继承自 base.html 文件 -->
{% extends "base.html" %}
{% load static %}

<!-- 写入 base.html 中定义的 title -->
{% block title %}
    文章详情
{% endblock title %}

<!-- 写入 base.html 中定义的 content -->
{% block content %}

<!-- 文章详情 -->
<div class="container">
    <div class="row">
        <!-- 标题及作者 -->
        <h1 class="col-12 mt-4 mb-4">{{ article.title }}</h1>
        <div class="col-12 alert alert-success">
          <div>
            作者：{{ article.author }}
            {% if user == article.author %}
            · <a href="#" onclick="confirm_delete()">删除文章</a>
            · <a href="{% url "article:article_update" article.id %}">编辑文章</a>
            {% endif %}
          </div>
          <div>
            浏览：{{ article.total_views }}
          </div>
        <!-- 新增一个隐藏的表单 -->
        <form 
             style="display:none;" 
             id="safe_delete"
             action="{% url 'article:article_safe_delete' article.id %}" 
             method="POST"
             >
            {% csrf_token %}
            <button type="submit">发送</button>
        </form>
        </div>
        <div class="col-3 mt-4">
            <h4><strong>目录</strong></h4>
            <hr>
            <div>
                {{ toc|safe }}
            </div>
          </div>
        <!-- 文章正文 -->
        <div class="col-12">
            {{ article.body|safe }}
        </div>

        <!-- 发表评论（调整后） -->
        <hr class="my-4">
        <div class="comment-section">
            <h4 class="mb-3"><strong>我也要发言：</strong></h4>
            {% if user.is_authenticated %}
                <div class="mb-5">
                    <form 
                        action="{% url 'comment:post_comment' article.id %}" 
                        method="POST"
                    >
                    {% csrf_token %}
                        <div class="form-group">
                            <textarea 
                                type="text" 
                                class="form-control rounded border" 
                                id="body" 
                                name="body" 
                                rows="3"
                                placeholder="分享你的想法..."></textarea>
                        </div>
                        <!-- 提交按钮 -->
                        <div class="text-right mt-2">
                            <button type="submit" class="btn btn-primary">发送</button>                    
                        </div>
                    </form>
                </div>
            {% else %}
                <div class="alert alert-light mb-5">
                    请<a href="{% url 'userprofile:login' %}" class="text-primary">登录</a>后参与评论
                </div>
            {% endif %}


            <!-- 显示评论（调整后，仿知乎风格） -->
            <h4 class="mb-4"><strong>共有{{ comments.count }}条评论</strong></h4>
            <div class="comments-list">
                {% for comment in comments %}
                    <div class="mb-4 pb-4 border-bottom">
                        <!-- 用户名 -->
                        <div class="mb-1">
                            <strong style="color: #1a1a1a;">{{ comment.user }}</strong>
                            {% if comment.user.is_staff %}
                                <span class="badge badge-primary ml-1" style="font-size: 0.7em;">作者</span>
                            {% endif %}
                        </div>
                        <!-- 评论内容 -->
                        <div class="mb-2 text-dark">
                            {{ comment.body|linebreaks }}
                        </div>
                        <!-- 时间和回复 -->
                        <div class="d-flex align-items-center text-muted small">
                            <span>{{ comment.created|date:"m-d · H:i" }}</span>
                            <span class="mx-3">·</span>
                            <a href="#" class="text-muted hover:text-primary">回复</a>
                        </div>
                    </div>
                {% empty %}
                    <div class="alert alert-light">
                        暂无评论，快来抢沙发吧~
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    // 删除文章的函数
    function confirm_delete() {
        // 调用layer弹窗组件
        layer.open({
            // 弹窗标题
            title: "确认删除",
            // 正文
            content: "确认删除这篇文章吗？",
            // 点击确定按钮后调用的回调函数
            yes: function(index, layero) {
                // 指定应当前往的 url
                $('form#safe_delete button').click();
                layer.close(index);
            },
        })
    }
</script>

{% endblock content %}