{% extends "base.html" %} {% load static %}
{% block title %}重置密码{% endblock title %}
{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-6 col-md-8">
      <div class="card shadow-sm">
        <div class="card-body">
          {% comment %} 显示全局或表单非字段错误 {% endcomment %}
          {% if form.non_field_errors %}
            <div class="alert alert-danger">
              {% for e in form.non_field_errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
            </div>
          {% endif %}

          {% if stage == 'request' %}
            <h4 class="mb-3">重置密码</h4>
            <p class="text-muted">请输入注册时使用的邮箱。如果该邮箱存在，我们会发送一封包含重置链接的邮件。</p>
            <form method="post" novalidate>
              {% csrf_token %}
              <div class="mb-3">
                <label class="form-label">{{ form.email.label }}</label>
                <input type="email" name="{{ form.email.name }}" class="form-control" value="{{ form.email.value|default:'' }}" required>
                {% if form.email.errors %}
                  <div class="text-danger small mt-1">
                    {% for err in form.email.errors %}{{ err }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
              <div class="d-flex align-items-center">
                <button class="btn btn-primary me-2" type="submit">发送重置邮件</button>
                <a class="btn btn-outline-secondary" href="{% url 'userprofile:login' %}">返回登录</a>
              </div>
            </form>

          {% elif stage == 'done' %}
            <h4 class="mb-3">已发送重置邮件</h4>
            <div class="alert alert-success">如果该邮箱存在，我们已发送重置链接。请检查收件箱与垃圾箱。</div>
            <a class="btn btn-secondary" href="{% url 'userprofile:login' %}">返回登录</a>

          {% elif validlink is not none %}
            {% if validlink %}
              <h4 class="mb-3">设置新密码</h4>
              <form method="post" novalidate>
                {% csrf_token %}
                <div class="mb-3">
                  <label class="form-label">{{ form.new_password1.label }}</label>
                  <input type="password" name="{{ form.new_password1.name }}" class="form-control" value="">
                  {% if form.new_password1.errors %}
                    <div class="text-danger small mt-1">
                      {% for err in form.new_password1.errors %}{{ err }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                    </div>
                  {% endif %}
                </div>
                <div class="mb-3">
                  <label class="form-label">{{ form.new_password2.label }}</label>
                  <input type="password" name="{{ form.new_password2.name }}" class="form-control" value="">
                  {% if form.new_password2.errors %}
                    <div class="text-danger small mt-1">
                      {% for err in form.new_password2.errors %}{{ err }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                    </div>
                  {% endif %}
                </div>
                <div class="d-flex">
                  <button class="btn btn-primary me-2" type="submit">保存新密码</button>
                  <a class="btn btn-link" href="{% url 'userprofile:login' %}">取消</a>
                </div>
              </form>
            {% else %}
              <h4 class="mb-3">链接无效</h4>
              <div class="alert alert-danger">该重置链接无效或已过期。请重新发起重置请求。</div>
              <a class="btn btn-primary" href="{% url 'password_reset' %}">重新发送重置邮件</a>
            {% endif %}

          {% elif stage == 'complete' %}
            <h4 class="mb-3">重置完成</h4>
            <div class="alert alert-success">密码已更新。请使用新密码登录。</div>
            <a class="btn btn-primary" href="{% url 'userprofile:login' %}">去登录</a>

          {% else %}
            <p>无可用状态。</p>
          {% endif %}
        </div>
      </div>
      <p class="text-center text-muted small mt-3">如果出现问题，请联系管理员。</p>
    </div>
  </div>
</div>
{% endblock content %}